---
title: "Compare Scenarios report EDGE-Transport"

output: 

  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 6
    number_sections: yes
    

params:
  hist: !r c("C:/Users/johannah/Documents/EDGE-Transport/HistoricalData/historical.mif")
  mif: !r c("C:/Users/johannah/Documents/EDGE-Transport/Output/SSP2-Mix2_2022-02-25_09.28.33/EDGE-T_SA.mif")
  y_bar: !r c(2010,2020,2030,2050,2100)
  yrs: !r c(seq(2010, 2060, 5), seq(2070, 2100, 10))
  regionchoice: !r c("CHA","JPN","DEU","IND","USA","CAZ")
  figWidth: 15 
  figHeight: 10
  warning: no

---

```{r, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE}
library(quitte)
library(mip)
library(ggplot2)
library(data.table)
library(dplyr)
library(tidyr)
library(tidyverse)
library(stats)
library(magclass)
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE,
  warning = params$warning,
  fig.width = params$figWidth, 
  fig.height = params$figHeight)
```

```{r read in mif data}
counter <- 2
data <- list()
for (i in 1:length(params$mif)){
  data0 <- read.quitte(params$mif[i],factors=FALSE)
  data0 <- as.data.table(data0)
  if (i > 1) {
   if ((length(data[scenario %in% unique(data0$scenario)]) > 0)){
    data0[, scenario := paste0(scenario,"_",counter)]
    counter <- counter+1}
  } 
  data <- rbind(data,data0)
}
```

```{r functions}
# Extra plotting functions
lineplot = function(varname, data){
    p=ggplot(data, aes(x = as.character(period), y = value,group = scenario, color = scenario))+
      geom_line(size = 1)+
      facet_wrap(~data$variable, nrow = 4, scales = "free")+
      scale_x_discrete(breaks = c(1990,2010,2030,2050,2100))+
      labs(x = "", y = paste0(varname," [", unique(data$unit),"]"), title = paste0(varname))
    return(p)
  }

mipBarYearDataMod <- function(x, colour = NULL, ylab = NULL, xlab = NULL, title = NULL,
                           scenario_markers = TRUE) { #nolint
  scenarioMarkers <- scenario_markers
  x <- as.quitte(x)
   

  if (length(unique(x$model)) > 1) {
    stop("this plot can only deal with data that have only one model")
  }

  if (!is.integer(x$period)) {
    stop("this plot can only deal with data that have integer periods")
  }

  # calculate y-axis label
  x$variable <- shorten_legend(x$variable, identical_only = TRUE)

  if (is.null(ylab)) {
     ylab <- paste0(sub(".$", "", attr(x$variable, "front")), attr(x$variable, "back"))
     # add unit
     unit <- unique(as.character(x$unit))
     ylab <- paste0(ylab, " (", paste0(unit, collapse = " | "), ")")
  }

  # add dummy-dimension for space between the time-steps
  xpos <- crossing(period   = unique(x$period),
                   region = factor(c(levels(x$region), "\x13"))) %>%
    order.levels(region = c(levels(x$region), "\x13")) %>%
    arrange(!!sym("period"), !!sym("region")) %>%
    mutate(xpos = 1:n()) %>%
    filter("\x13" != !!sym("region")) %>%
    droplevels()

  x <- x %>%
    inner_join(
      xpos,

      c("region", "period")
    )

  if (scenarioMarkers) {
    yMarker <- crossing(
      x %>%
        group_by(!!sym("scenario"), !!sym("xpos")) %>%
        summarise(top    = sum(pmax(0, !!sym("value"))),
                  bottom = sum(pmin(0, !!sym("value")))) %>%
        summarise(top    = max(!!sym("top")),
                  bottom = min(!!sym("bottom"))) %>%
        mutate(
          y = !!sym("bottom") - 0.05 * (!!sym("top") + !!sym("bottom"))) %>%
        select(-"top", -"bottom"),

      xpos
    )
  }
  
  if (scenarioMarkers) {

    scenarioMarkers <- setNames((1:20)[seq_along(unique(x$region))],
                                 levels(x$region))
  }

  # calculate positions of period labels
  if (any(scenarioMarkers)) {
    xpos <- xpos %>%
      group_by(!!sym("period")) %>%
      summarise(xpos = mean(!!sym("xpos")))
  }

  if (is.null(colour)) {
    colour <- plotstyle(levels(x$variable))
  }

  # make plot
  p <- ggplot() +
    geom_col(data = x,
             mapping = aes(x = !!sym("xpos"), y = !!sym("value"),
                           fill = !!sym("variable"))) +
    scale_fill_manual(values = colour, name = NULL,
                      guide = guide_legend(reverse = TRUE)) +
    facet_wrap(~scenario, scales = "free_y") +
    labs(x = xlab, y = ylab, title = title) +
    theme(legend.position = "bottom")

  # add markers
  if (any(scenarioMarkers)) {
    p <- p +
      scale_x_continuous(breaks = xpos$xpos,
                         labels = xpos$period) +
      geom_point(data = yMarker,
                 mapping = aes(x = !!sym("xpos"), y = !!sym("y"),
                               shape = !!sym("region")),
                 size = 1.5) +
      scale_shape_manual(values = scenarioMarkers, name = NULL) +
      theme(legend.box = "vertical")
  } else {
    p <- p +
      scale_x_continuous(breaks = xpos$xpos,
                         labels = xpos %>%
                           unite(!!sym("label"), !!sym("region"),
                                 !!sym("period"), sep = " ") %>%
                           getElement("label")) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  }

  return(p)
}

```

## ES shares by transport mode
###Passenger w/o bunkers
```{r ES shares Passenger by transport mode}

  vars <- c(
    "ES|Transport|Pass|Aviation|Domestic|Share w/o bunkers",
    "ES|Transport|Pass|Rail|non-HSR|Share w/o bunkers",
    "ES|Transport|Pass|Rail|HSR|Share w/o bunkers",
    "ES|Transport|Pass|Road|Bus|Share w/o bunkers",
    "ES|Transport|Pass|Road|LDV|Share w/o bunkers",
    "ES|Transport|Pass|Road|Non-Motorized|Walking|Share w/o bunkers",
    "ES|Transport|Pass|Road|Non-Motorized|Cycling|Share w/o bunkers"
  )

  plotdata <- data[variable %in% vars]
  p1 <- mipBarYearData(plotdata[region %in% params$regionchoice & period %in% params$y_bar])
  p1 <- p1 + theme_mip(size = 18)
  print(p1)
```

###Freight
```{r ES shares Freight by transport mode}

 vars <- c(
    "ES|Transport|Freight|Road|Share w/o bunkers",
    "ES|Transport|Freight|Rail|Share w/o bunkers",
    "ES|Transport|Freight|Navigation|Share w/o bunkers"
  )

  plotdata <- data[variable %in% vars]
  p1 <- mipBarYearData(plotdata[region %in% params$regionchoice & period %in% params$y_bar])
  p1 <- p1 + theme_mip(size = 18)
  print(p1)

```

## ES shares by vehicle Sizes
###Passenger
```{r ES shares by vehicle Sizes}

  vars <- c(
       "ES|Transport|Pass|Road|LDV|Large|Share",
       "ES|Transport|Pass|Road|LDV|Medium|Share",
       "ES|Transport|Pass|Road|LDV|SUV|Share",
       "ES|Transport|Pass|Road|LDV|Mini|Share",
       "ES|Transport|Pass|Road|LDV|Small|Share",
       "ES|Transport|Pass|Road|LDV|Van|Share"
  )

  plotdata <- data[variable %in% vars]
  p1 <- mipBarYearData(plotdata[region %in% params$regionchoice & period %in% params$y_bar])
  p1 <- p1 + theme_mip(size = 18)
  print(p1)

```

## Prices S3S
```{r Prices S3S}

  scen <- unique(data$scenario)

for (reg0 in params$regionchoice) {
  plotdata <- data[grepl("Logit cost\\|S3S\\|(Walk|Cycle|trn_pass_road|Domestic Aviation|Passenger Rail|HSR)",variable)]
  plotdata <- plotdata[region==reg0][,region:=NULL]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|S3S\\|","",variable)][period %in% params$y_bar]
  setnames(plotdata, "scenario","region")
  plotdata <- plotdata[, scenario:=gsub("\\|Eq inconvenience cost|\\|tot_VOT_price|\\|fuel_price_pkm|\\|non_fuel_price","",variable)]
  plotdata <- plotdata[, variable:=gsub("Walk\\||Cycle\\||trn_pass_road\\||Domestic Aviation\\||Passenger Rail\\||HSR\\|","",variable)]
  plotdata[, factor(variable, levels = c("Eq inconvenience cost","tot_VOT_price","fuel_price_pkm","non_fuel_price"))]
  
  p2 <- mipBarYearData(plotdata, ylab = "Prices logit S3S [USD2005/pkm]", title = paste0("Prices logit S3S ",reg0) )
  p2 <- p2 + theme_mip(size = 18)
  print(p2)}

```

## Prices S2S3
```{r Prices S2S3}

for (reg0 in params$regionchoice) {
  plotdata <- data[grepl("Logit cost\\|S2S3\\|(Bus|trn_pass_road_LDV)",variable)]
  plotdata <- plotdata[region==reg0][, region:=NULL]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|S2S3\\|", "",variable)][period %in% params$y_bar]
  setnames(plotdata, "scenario","region")
  plotdata <- plotdata[, scenario := gsub("\\|Eq inconvenience cost|\\|tot_VOT_price|\\|fuel_price_pkm|\\|non_fuel_price", "", variable)]
  plotdata <- plotdata[, variable := gsub("Bus\\||trn_pass_road_LDV\\|","", variable)]
  plotdata[, variable := factor(variable, levels = c("Eq inconvenience cost","tot_VOT_price","fuel_price_pkm","non_fuel_price"))]

  p2 <- mipBarYearData(plotdata, ylab = "Prices logit S2S3 [USD2005/pkm]", title = paste0("Prices logit S2S3 ",reg0))
  p2 <- p2 + theme_mip(size = 18)
  print(p2)}

```

## Prices S1S2
```{r Prices S1S2}

for (reg0 in params$regionchoice) {
  plotdata <- data[grepl("Logit cost\\|S1S2\\|(trn_pass_road_LDV_4W|trn_pass_road_LDV_2W)",variable)]
  plotdata <- plotdata[region==reg0][,region:=NULL]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|S1S2\\|", "",variable)][period %in% params$y_bar]  
  setnames(plotdata, "scenario","region")
  plotdata <- plotdata[, scenario := gsub("\\|Eq inconvenience cost|\\|tot_VOT_price|\\|fuel_price_pkm|\\|non_fuel_price", "", variable)]
  plotdata <- plotdata[, variable := gsub("trn_pass_road_LDV_4W\\||trn_pass_road_LDV_2W\\|", "", variable)]
  plotdata[, variable := factor(variable, levels = c("Eq inconvenience cost","tot_VOT_price","fuel_price_pkm","non_fuel_price"))]
  

  p2 <- mipBarYearData(plotdata, ylab = "Prices logit S1S2 [USD2005/pkm]", title = paste0("Prices logit S1S2 ",reg0))
  p2 <- p2 + theme_mip(size = 18)
  print(p2)}

```

## Prices VS1
```{r Prices VS1}

for (reg0 in params$regionchoice) {
  plotdata <- data[grepl("Logit cost\\|VS1\\|LDV\\|(Mini|Medium|Large|SUV|Van|Small)",variable)]
  plotdata <- plotdata[region==reg0][,region:=NULL]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|VS1\\|LDV\\|", "",variable)][period %in% params$y_bar]  
  setnames(plotdata, "scenario","region")
  plotdata <- plotdata[, scenario := gsub("\\|Eq inconvenience cost|\\|tot_VOT_price|\\|fuel_price_pkm|\\|non_fuel_price", "", variable)]
  plotdata <- plotdata[, variable := gsub("Mini\\||Large\\||SUV\\||Van\\||Small\\||Medium\\|", "", variable)]
  plotdata[, variable := factor(variable, levels = c("Eq inconvenience cost","tot_VOT_price","fuel_price_pkm","non_fuel_price"))]
  
  p2 <- mipBarYearData(plotdata[period %in% params$y_bar],ylab="Prices logit VS1 [USD2005/pkm]", title = paste0("Prices logit VS1 ",reg0))
  p2 <- p2 + theme_mip(size = 18)
  print(p2)}

```

## Prices VS1 region comparison
```{r Prices VS1 region comparison}

vars <- c("Mini","Medium","Large","SUV","Van","Small")

for (var0 in vars) {
  
  plotdata <- data[grepl(paste0("Logit cost\\|VS1\\|LDV\\|",var0),variable)]
  plotdata <- plotdata[region %in% params$regionchoice]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|VS1\\|LDV\\|", "",variable)][period %in% params$y_bar]
  
  plotdata <- plotdata[, variable := gsub("Mini\\||Large\\||SUV\\||Van\\||Small\\||Medium\\|", "", variable)]
  plotdata[, variable := factor(variable, levels = c("Eq inconvenience cost","tot_VOT_price","fuel_price_pkm","non_fuel_price"))]
  
  p2 <- mipBarYearDataMod(plotdata[period %in% params$y_bar],ylab = "Prices logit VS1 [USD2005/pkm]", title = paste0("Prices logit VS1 ",var0))
  p2 <- p2 + theme_mip(size = 18) 
  print(p2)}

```

## Average LDV non fuel prices
```{r Average LDV non fuel prices}

  plotdata <- data[grepl("Logit cost\\|S1S2\\|trn_pass_road_LDV_4W\\|non_fuel_price",variable) & period %in% params$yrs & region %in% params$regionchoice]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|S1S2\\|", "",variable)][, variable := NULL]
  
  # Extra plotting functions
 
  p=ggplot(plotdata, aes(x = as.character(period), y = value, group = region, color = region))+
      geom_line(size = 0.5)+
      facet_wrap(~scenario, nrow = 4, scales = "free")+
      scale_x_discrete(breaks = c(2010,2030,2050,2100))+
      labs(x = "", y = paste0("Average LDV 4W non fuel prices","[", unique(data$unit),"]"), title = paste0("Average LDV 4W non fuel prices"))

  print(p)


```

## Average LDV total price
```{r Average LDV total price}

  plotdata <- data[grepl("Logit cost\\|S1S2\\|trn_pass_road_LDV_4W\\|",variable) & period %in% params$yrs & region %in% params$regionchoice]
  plotdata <- plotdata[, variable := gsub("Logit cost\\|S1S2\\|trn_pass_road_LDV_4W\\|", "",variable)]
  plotdata <- plotdata[, .(value = sum(value)), by = c("region","scenario","period","unit")]
  
  # Extra plotting functions
 
  p=ggplot(plotdata, aes(x = as.character(period), y = value, group = region, color = region))+
      geom_line(size = 0.5)+
      facet_wrap(~scenario, nrow = 4, scales = "free")+
      scale_x_discrete(breaks = c(2010,2030,2050,2100))+
      labs(x = "", y = paste0("Total LDV 4W logit costs","[", unique(data$unit),"]"), title = paste0("Total LDV 4W logit costs"))

  print(p)


```

## Shareweight trends
```{r Shareweight trends}


for (reg0 in params$regionchoice) {

  plotdata <- data[grepl("Shareweight\\|S3\\|(Walk|Cycle|trn_pass_road|Domestic Aviation|Passenger Rail|HSR)",variable) & region == reg0]
  plotdata <- plotdata[, variable := gsub("Shareweight\\|S3\\|", "",variable)]

  p <- lineplot(varname = paste0("Shareweight trend S3 ", reg0), data = plotdata)
  print(p)

  plotdata <- data[grepl("Shareweight\\|S2\\|(Bus|trn_pass_road_LDV)",variable) & region == reg0]
  plotdata <- plotdata[, variable := gsub("Shareweight\\|S2\\|", "",variable)]
  
  p <- lineplot(varname = paste0("Shareweight trend S2 ", reg0), data= plotdata)
  print(p)

  plotdata <- data[grepl("Shareweight\\|S1\\|(trn_pass_road_LDV_2W|trn_pass_road_LDV_4W)",variable) & region == reg0]
  plotdata <- plotdata[, variable := gsub("Shareweight\\|S1\\|", "",variable)]
  
  p <- lineplot(varname = paste0("Shareweight trend S1 ", reg0), data= plotdata)
  print(p)}


```

